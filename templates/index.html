{% extends "base.html" %}
{% block content %}
<div class="row g-4">
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header">
        <strong>Request Payment</strong>
      </div>
      <div class="card-body">
        <form action="/" method="post" class="vstack gap-3">
          <div class="row g-3">
            <div class="col-6">
              <label for="amount" class="form-label">Amount (AUD)</label>
              <input type="text" class="form-control" id="amount" name="amount" value="{{ amount }}" />
            </div>
            <div class="col-6">
              <label class="form-label">Amount (KAS)</label>
              <input type="text" class="form-control" id="kas_amount" value="{{ kas_amount }}" disabled />
              <div class="form-text" id="rate_info">Rate: 1 KAS ≈ {{ rate_aud_per_kas or '…' }} AUD{% if rate_updated %} (as of {{ rate_updated }}){% endif %}</div>
            </div>
          </div>

          <div>
            <label for="message" class="form-label">Message to customer</label>
            <textarea class="form-control" id="message" name="message" rows="2"
                      placeholder="Thanks from Bean-Me-Up coffee">{{ message }}</textarea>
            <div class="form-text">
              This appears in the payment request payload.
            </div>
          </div>

          <button type="submit" class="btn btn-primary" id="request-btn">
            <i class="bi bi-pencil-square me-1"></i> Request {{ kas_amount or 'KAS' }} Kaspa
          </button>
        </form>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <div class="card shadow-sm mb-3">
      <div class="card-header"><strong>Help</strong></div>
      <div class="card-body">
        <p class="mb-0">Admin moves address, transport, preview, and status to <a href="/admin">/admin</a>.</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Live KAS conversion on amount changes, with periodic rate refresh.
  (function(){
    const amt = document.getElementById('amount');
    const kas = document.getElementById('kas_amount');
    const btn = document.getElementById('request-btn');
    let rate = {{ rate_aud_per_kas or 'null' }};

    function fmtKas(v){
      const s = (Math.round(v * 1e8) / 1e8).toFixed(8).replace(/0+$/,'').replace(/\.$/,'');
      return s || '0';
    }
    function update(){
      const v = parseFloat(amt.value);
      if (!isFinite(v) || !rate || rate <= 0) return;
      const k = v / rate;
      const s = fmtKas(k);
      if (kas) kas.value = s;
      if (btn) btn.innerHTML = '<i class="bi bi-pencil-square me-1"></i> Request ' + s + ' Kaspa';
    }
    async function refreshRate(){
      try {
        const r = await fetch('/rate.json?ts='+Date.now());
        const j = await r.json();
        if (j && j.aud_per_kas) {
          rate = j.aud_per_kas;
          update();
          const info = document.getElementById('rate_info');
          if (info) {
            const t = j.updated_at ? new Date(j.updated_at).toLocaleTimeString() : null;
            info.textContent = 'Rate: 1 KAS ≈ ' + rate + ' AUD' + (t ? ' (as of ' + t + ')' : '');
          }
        }
      } catch {}
    }
    if (amt) amt.addEventListener('input', update);
    update();
    setInterval(refreshRate, 600000); // 10 minutes
    setTimeout(refreshRate, 1000);
  })();
</script>
{% endblock %}
